# 1) Probe: can we log in with the configured root password?
- name: Probe root login with password
  community.mysql.mysql_info:
    login_user: root
    login_password: "{{ mysql_root_password }}"
  register: mysql_root_login
  ignore_errors: true

# 2) If password login fails, set/ensure root password via unix socket (bootstrap)
- name: Bootstrap root password via unix socket (first run only)
  community.mysql.mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: true
    state: present
  when: mysql_root_login is failed

# 3) From here on, always use explicit password login
- name: Remove anonymous users
  community.mysql.mysql_user:
    name: ''
    host_all: true
    login_user: root
    login_password: "{{ mysql_root_password }}"
    state: absent

- name: Drop test database
  community.mysql.mysql_db:
    name: test
    state: absent
    login_user: root
    login_password: "{{ mysql_root_password }}"